CLASS zcl_zo2c_amdp_sale_analysis DEFINITION
  PUBLIC
  FINAL
  CREATE PUBLIC .

  PUBLIC SECTION.

    INTERFACES if_amdp_marker_hdb.
    CLASS-METHODS : oil_wise_sale FOR TABLE FUNCTION zo2c_oil_wise_sale.
    CLASS-METHODS : zone_wise_oil_sale FOR TABLE FUNCTION zo2c_zone_w_oil_sale.
    CLASS-METHODS : line_oil_wise_sale FOR TABLE FUNCTION zo2c_line_oil_w_sale.
    CLASS-METHODS : line_zone_mfs_sale FOR TABLE FUNCTION zo2c_line_zone_mfs_sale.
    CLASS-METHODS : all_line_wise_mfs_sale FOR TABLE FUNCTION  zo2c_line_wise_sale_mfs.
    CLASS-METHODS : sales_data_dump FOR TABLE FUNCTION zo2c_sales_data_dump .

  PROTECTED SECTION.

  PRIVATE SECTION.

ENDCLASS.



CLASS ZCL_ZO2C_AMDP_SALE_ANALYSIS IMPLEMENTATION.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Static Public Method ZCL_ZO2C_AMDP_SALE_ANALYSIS=>OIL_WISE_SALE
* +-------------------------------------------------------------------------------------------------+
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD oil_wise_sale BY DATABASE FUNCTION FOR HDB LANGUAGE SQLSCRIPT
                 OPTIONS  READ-ONLY  USING  t179 vbrk vbrp t179t marm  zo2c_target_val ififyearperiod .

    declare v1 varchar(10);
    declare v2 varchar(10);
    declare v3 varchar(10);
    declare v4 varchar(10);
    declare v5 varchar(10);
    declare mth_first_date varchar(10 );
    declare mth_last_date varchar( 10) ;
    declare mth_first_date1 date;
    declare mth_last_date1 date ;
    declare pymth_first_date varchar(8) ;
    declare pymth_last_date varchar(8) ;
    declare py_mth_first_date varchar(8) ;
    declare py_last_date varchar(8) ;
    declare cal int;
    declare curr_fiscal_year varchar( 4) ;
    declare pre_fiscal_year varchar( 4) ;
    declare cy_first_date varchar(8);
    declare py_first_date varchar(8);
    declare tot_curr_year_sale decimal;
    declare fiscal_period numeric;
    declare pymth_date varchar(8);
    declare today_date date;

 IF month_date > session_context('SAP_SYSTEM_DATE') then
    month_date = session_context('SAP_SYSTEM_DATE');
  ELSE
* --- Do Nothing
 END IF ;

*-- Current Month First Date
  SELECT add_months(next_day(last_day(month_date)),-1) INTO mth_first_date1 FROM dummy;

*--- Current Month Last Date
 SELECT last_day(month_date) INTO mth_last_date1 FROM dummy;


*-- Get Current fiscal year/ Period
    SELECT DISTINCT fiscalyear , fiscalperiod INTO curr_fiscal_year,fiscal_period FROM ififyearperiod
        WHERE fiscalyearvariant = 'V3' AND  fiscalperiodstartdate = mth_first_date1 AND fiscalperiodenddate =  mth_last_date1
                                                         AND mandt = session_context( 'CLIENT' );


**-- Previous Fiscal Year
      pre_fiscal_year = curr_fiscal_year - 1;

*-- Get previous fiscal year last date
    SELECT DISTINCT fiscalperiodstartdate, fiscalperiodenddate INTO pymth_first_date , pymth_last_date FROM ififyearperiod
        WHERE fiscalyearvariant = 'V3' AND fiscalyear = :pre_fiscal_year AND fiscalperiod = :fiscal_period
                                AND mandt = session_context( 'CLIENT' );


* First Date
    cy_first_date = concat(  curr_fiscal_year,'0401' );
    py_first_date = concat(  pre_fiscal_year,'0401' );

*   Convert to YYYYMMDD
    v1 = cast(mth_first_date1 as varchar);
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_first_date = concat( v5,v4);

*   Convert to YYYYMMDD
    v1 = cast(mth_last_date1 as varchar);
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_last_date = concat( v5,v4);

    IF month_date = mth_last_date then
       pymth_date = pymth_last_date;
    ELSE
      v1 = cast(month_date as varchar);
      v2 = substring(v1,1,4) - 1 ;
      v3 = substring(v1,5,4);
       pymth_date = concat( v2,v3 );
    END if;

*cast(sum(a.salesmonthly_ton) as abap.fltp(16,16) )

*--- Current Year sale - As on Date
 curry_tot_sale =  SELECT a.mandt , substring(a.prodh,1,6) as prod_h, b.matnr,
                   0.00 as  curry_mth_sale,
                   CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                   when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                   when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                   CASE WHEN C.vbtyp <> 'N' and C.vbtyp <> 'O' and C.vbtyp <> 'S' THEN
                       cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3))
                      WHEN C.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                       WHEN C.vbtyp = 'O' AND C.fkart = 'ZRTD' THEN
                         cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                       WHEN  C.vbtyp = 'S'  AND C.fkart = 'S2' AND C.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                      END
                    end as curry_sale ,
                    0.00 as  prey_mth_sale,
                    0.00 as prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on b.vbeln = c.vbeln
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                   where  a.stufe = '7' and a.prodh like '11%' and a.mandt = session_context( 'CLIENT' )
                   and c.vbtyp <> 'P' and ( c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO'  ) and c.vkorg in ( 1000 , 1001)
                   and C.fkdat between cy_first_date and month_date
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where  vkorg in ( 1000 , 1001) and
                   ( fkart = 'ZGST' OR  fkart = 'YSTO' ) and  fkdat between cy_first_date and month_date  )   )
                   group by a.mandt, substring(a.prodh,1,6) ,b.matnr,C.vbtyp,C.fkart,C.fktyp, marm_from.umren, marm_to.umren;


*--- Previous Year Sale - As on previous year date
 py_tot_sale   =  SELECT a.mandt , substring(a.prodh,1,6) as prod_h, b.matnr,
                    0.00 as  curry_mth_sale,
                    0.00 as curry_sale ,
                    0.00 as  prey_mth_sale,
                   CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                   when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                   when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                   CASE WHEN C.vbtyp <> 'N' and C.vbtyp <> 'O' and C.vbtyp <> 'S' THEN
                     cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3))
                      WHEN C.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                       WHEN C.vbtyp = 'O' AND C.fkart = 'ZRTD' THEN
                          cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                       WHEN  c.vbtyp = 'S'  AND C.fkart = 'S2' AND C.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                     END
                   end as  prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on b.vbeln = c.vbeln
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                   where  a.stufe = '7' and a.prodh like '11%' and a.mandt = session_context( 'CLIENT' )
                   and c.vbtyp <> 'P' and (  c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO'  )
                   and c.vkorg in ( 1000 , 1001) and c.fkdat between py_first_date and pymth_date
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
                   and ( fkart =  'YSTO' OR  fkart = 'ZGST' )  and  fkdat between py_first_date and pymth_date   )   )
                   group by a.mandt, substring(a.prodh,1,6) ,b.matnr,C.vbtyp,C.fkart ,C.fktyp,  marm_from.umren, marm_to.umren;


*-- Sale in  Current Year Month and Previous Year Same Month
 mth_tot_sale   =  SELECT a.mandt , substring(a.prodh,1,6) as prod_h, b.matnr ,
                   CASE when ( marm_to.umren   = 0 or marm_to.umren   is null or marm_from.umren = 0 or marm_from.umren is NULL ) then 0.000
                       when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                        case when c.fkdat BETWEEN mth_first_date and month_date AND  ( c.vbtyp <> 'N' and  c.vbtyp <> 'O' and  c.vbtyp <> 'S' ) THEN
                         cast( sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3) )
                         when c.fkdat BETWEEN mth_first_date and month_date and ( c.vbtyp = 'N' or  c.vbtyp = 'O' or c.vbtyp = 'S')   THEN
                            CASE WHEN  c.vbtyp = 'N' THEN
                            cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC(18,3) )
                            WHEN c.vbtyp = 'O' AND  C.fkart = 'ZRTD'THEN
                              cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC(18,3) )
                            when c.vbtyp = 'S' AND c.fkart = 'S2' AND C.fktyp = 'L' THEN
                               cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )   as DEC(18,3) )
                            END
                        END
                     end as curry_mth_sale,
                     0.00 as curry_sale ,
                     CASE when ( marm_to.umren   = 0 or marm_to.umren   is null or marm_from.umren = 0 or marm_from.umren is NULL ) then 0.000
                       when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                       case when c.fkdat BETWEEN pymth_first_date and pymth_date AND  ( c.vbtyp <> 'N' and  c.vbtyp <> 'O'  and c.vbtyp <> 'S' ) THEN
                             cast( sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3) )
                           when c.fkdat BETWEEN pymth_first_date and pymth_date AND  ( c.vbtyp = 'N' or  c.vbtyp = 'O'  or c.vbtyp = 'S' ) THEN
                             case WHEN  c.vbtyp = 'N' THEN
                             cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC(18,3) )
                             WHEN c.vbtyp = 'O' AND C.fkart = 'ZRTD'THEN
                               cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC(18,3) )
                            when c.vbtyp = 'S' AND  c.fkart = 'S2' AND C.fktyp = 'L' THEN
                              cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )   as DEC(18,3) )
                            END
                          END
                       END as prey_mth_sale,
                   0.00 as  prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on b.vbeln = c.vbeln
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' )  and
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                   where  a.stufe = '7' and a.prodh like '11%'  and a.mandt = session_context( 'CLIENT' )
                   and c.vbtyp <> 'P' AND ( c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO') and c.vkorg in ( 1000 , 1001)
                   and (  C.fkdat between mth_first_date and month_date or C.fkdat BETWEEN py_first_date and pymth_date)
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001) and
                   ( fkart = 'ZGST' or fkart = 'YSTO' ) and ( fkdat between mth_first_date and month_date or fkdat BETWEEN py_first_date and pymth_date)  )   )
                   group by a.mandt, substring(a.prodh,1,6),b.matnr,b.vrkme,c.vbtyp,c.fkart,C.fktyp,marm_from.umren, marm_to.umren, c.fkdat;


  total_sale =    select a.mandt , a.prod_h, a.matnr,  a.curry_mth_sale, a.curry_sale , a.prey_mth_sale, a.prey_sale from :curry_tot_sale as a
                   union ALL
                  select b.mandt , b.prod_h, b.matnr , b.curry_mth_sale, b.curry_sale , b.prey_mth_sale, b.prey_sale from :py_tot_sale as b
                   union ALL
                  select c.mandt , c.prod_h, c.matnr ,  c.curry_mth_sale, c.curry_sale , c.prey_mth_sale, c.prey_sale from :mth_tot_sale as c;

*-- Total Sale in Curr. Year and Input Month , Previous Year ,Pre. Month
  final_sale =  select DISTINCT a.mandt, substring(a.prod_h,1,6) as prod_h, sum(a.curry_mth_sale) as curry_mth_sale,
                    sum(curry_sale) as curr_year_sale , sum(prey_mth_sale ) AS prey_mth_sale , sum(prey_sale ) as  pre_year_sale
                    from :total_sale as a where a.prod_h is NOT NULL
                    group by a.mandt, substring( a.prod_h,1,6);

**-- Target for current year
  t_target = select a.mandt, a.prod_typ , a.begda , a.endda , cast(sum(a.fkimg) as DEC (18,3) ) as fkimg  from zo2c_target_val as a
               left outer join :final_sale as b on a.prod_brand = b.prod_h and a.mandt = session_context( 'CLIENT' )
               where prod_cat = '11' and a.begda BETWEEN cy_first_date and mth_first_date and a.endda <=  mth_last_date
               group by a.mandt, a.prod_typ, a.begda , a.endda ;


   seg_target = select mandt, prod_typ , fkimg ,
                     case when a.begda >= cy_first_date and a.endda <= mth_last_date THEN
                        a.fkimg else
                        0 end as curry_trgt,
                       case when a.begda >= mth_first_date and a.endda <= mth_last_date THEN
                        a.fkimg  else
                        0 end as curry_mth_trgt,
                       case when a.begda >= py_first_date and a.endda <= pymth_last_date THEN
                        a.fkimg else
                        0 end as  prey_trgt,
                        case when a.begda >= pymth_first_date and a.endda <= pymth_last_date THEN
                        a.fkimg else
                        0 end as  prey_mth_trgt
                        from :t_target as a  ;

*
  total_target = select mandt, prod_typ , sum(curry_trgt ) as curry_target, sum(curry_mth_trgt) as curry_mth_trgt ,
                      sum(prey_trgt) as prey_target, sum( prey_mth_trgt) from :seg_target
                      GROUP BY mandt, prod_typ;


   it_final =  SELECT  a.mandt , a.prod_typ as prod_h ,
                 b.curry_mth_sale , b.curr_year_sale , b.pre_year_sale , b.prey_mth_sale,
                 a.curry_target , a.curry_mth_trgt
                 from :total_target as a
                 left OUTER join :final_sale  as b on b.prod_h = a.prod_typ;


  final_oil_w_sale =  SELECT DISTINCT a.mandt , substring( a.prod_h,5,2) as prod_h ,upper( b.vtext) as product_name,
                       sum(a.curry_mth_sale) as curry_mth_sale , sum(a.curr_year_sale) as curr_year_sale ,
                        sum(a.pre_year_sale) as pre_year_sale  , sum(a.prey_mth_sale) as prey_mth_sale,
                       sum( a.curry_target ) as curry_target,sum(  a.curry_mth_trgt ) as curry_mth_trgt
                        from :it_final as a INNER join t179t as b on a.prod_h = b.prodh  and a.mandt = b.mandt
                        GROUP BY a.mandt , substring( a.prod_h,5,2), b.vtext;


   it_final_total =   SELECT DISTINCT mandt, sum(curry_mth_sale) as tot_cy_mth_sale, sum(curr_year_sale) as  tot_cy_sale ,
                      sum(pre_year_sale) as tot_py_sale , sum(prey_mth_sale) as tot_py_mth_sale, sum(curry_target) as tot_cy_trgt ,
                      sum(curry_mth_trgt) as tot_cy_mth_trgt from :it_final  GROUP BY mandt;



   RETURN SELECT DISTINCT a.mandt, a.prod_h as prod_h, a.product_name, a.curry_mth_trgt ,a.curry_mth_sale ,
                         case when a.curry_mth_trgt > 0 then
                          (cast(( a.curry_mth_sale / a.curry_mth_trgt ) * 100 as DEC (18,3) ))
                           else 0.00
                           end as ach ,
                         a.prey_mth_sale ,

                          case when a.prey_mth_sale > 0 then
                           ( ( a.curry_mth_sale - a.prey_mth_sale ) * 100  ) /a.prey_mth_sale
                          else
                          100 end as grw ,

                        a.curry_target  as curry_trgt ,
                        a.curr_year_sale,

                        cast( (a.curr_year_sale * 100 ) / tot_curr_year_sale as dec(18,3) ) as contr ,
                        case when a.curry_target > 0 then
                         cast((a.curr_year_sale * 100 ) / a.curry_target as DEC (18,3) )
                         else 100
                        end as y_ach,
                         a.pre_year_sale,
                        case when pre_year_sale > 0 then
                        cast( ( (a.curr_year_sale - pre_year_sale ) * 100 ) / a.pre_year_sale as dec( 18,3) )
                        else
                        100 end as y_grw,
*                        'MT' as unit,
                        C.tot_cy_mth_trgt,
                        c.tot_cy_mth_sale,
                        C.tot_py_mth_sale,
                        C. tot_cy_trgt,
                        C.tot_cy_sale,
                        C.tot_py_sale
                        FROM :final_oil_w_sale as a
                        left OUTER join :it_final_total as c on a.mandt = c.mandt;

  endmethod.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Static Public Method ZCL_ZO2C_AMDP_SALE_ANALYSIS=>ZONE_WISE_OIL_SALE
* +-------------------------------------------------------------------------------------------------+
* +--------------------------------------------------------------------------------------</SIGNATURE>
  method : zone_wise_oil_sale BY DATABASE FUNCTION FOR HDB LANGUAGE SQLSCRIPT
                  OPTIONS READ-ONLY USING t179 vbrk vbrp marm zo2c_target_val ififyearperiod t179t .

    declare v1 varchar(10);
    declare v2 varchar(10);
    declare v3 varchar(10);
    declare v4 varchar(10);
    declare v5 varchar(10);
    declare mth_first_date varchar(10 );
    declare mth_last_date varchar( 10) ;
    declare mth_first_date1 date;
    declare mth_last_date1 date ;
    declare pymth_first_date varchar(8) ;
    declare pymth_last_date varchar(8) ;
*    declare py_mth_first_date varchar(8) ;
    declare py_last_date varchar(8) ;
    declare curr_fiscal_year varchar( 4) ;
    declare pre_fiscal_year varchar( 4) ;
    declare cy_first_date varchar(8);
    declare py_first_date varchar(8);
    declare tot_curr_year_sale decimal;
    declare zone varchar(2);
    declare fiscal_period numeric;


*
 if p_date > session_context('SAP_SYSTEM_DATE') then
    p_date = session_context('SAP_SYSTEM_DATE');
  else
* --- Do Nothing
 end if ;

*-- Current Month First Date
  SELECT add_months(next_day(last_day(p_date)),-1) INTO mth_first_date1 FROM dummy;

*--- Current Month Last Date
 SELECT last_day(p_date) INTO mth_last_date1 FROM dummy;

*-- Get Current fiscal year/ Period
  select DISTINCT fiscalyear , fiscalperiod into curr_fiscal_year,fiscal_period from ififyearperiod
      where fiscalyearvariant = 'V3' AND  fiscalperiodstartdate = mth_first_date1 and fiscalperiodenddate =  mth_last_date1;

    pre_fiscal_year = curr_fiscal_year - 1;

*-- Get previous fiscal year last date
    SELECT DISTINCT fiscalperiodstartdate, fiscalperiodenddate INTO pymth_first_date , pymth_last_date FROM ififyearperiod
        WHERE fiscalyearvariant = 'V3' AND fiscalyear = :pre_fiscal_year AND fiscalperiod = :fiscal_period
                                AND mandt = session_context( 'CLIENT' );




    cy_first_date = concat(  curr_fiscal_year,'0401' );
    py_first_date = concat(  pre_fiscal_year,'0401' );

*   Convert to YYYYMMDD
    v1 = cast(mth_first_date1 as varchar);
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_first_date = concat( v5,v4);
*   Convert to YYYYMMDD
    v1 = cast(mth_last_date1 as varchar);
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_last_date = concat( v5,v4);


* * Previous year date for Current Year 29.02.YYYY
    IF p_date = mth_last_date then
      py_last_date = pymth_last_date;
    ELSE
      v1 = cast(p_date as varchar);
      v2 = substring(v1,1,4) - 1 ;
      v3 = substring(v1,5,4);
       py_last_date = concat( v2,v3 );
    END if;


   zone =   concat( p_zone, '%' );


*--- Current Year sale - As on Date
   curry_tot_sale =  SELECT a.mandt , substring(a.prodh,1,6) as prod_h, b.matnr,
                      CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                   when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                   when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                    CASE WHEN C.vbtyp <> 'N' and C.vbtyp <> 'O' AND C.vbtyp <> 'S' THEN
                      cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3))
                     WHEN C.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                     WHEN C.vbtyp = 'O' and c.fkart = 'ZRTD' THEN
                         cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                     WHEN  c.vbtyp = 'S'  and C.fkart = 'S2' AND C.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                     END
                   end as curry_sale,
                   0.000 as prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on a.mandt = b.mandt and b.vbeln = c.vbeln
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                   where  a.stufe = '7' and a.prodh like '11%' and b.vkbur like zone and a.mandt = session_context( 'CLIENT' )
                   and c.vbtyp <> 'P' and (  c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO'  ) and c.vkorg in ( 1000 , 1001)
                   and C.fkdat between cy_first_date and p_date
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
                   and (  fkart = 'ZGST' or fkart = 'YSTO'  ) and  fkdat between cy_first_date and p_date  and vkorg in ( 1000 , 1001) )   )
                   group by a.mandt, substring(a.prodh,1,6) ,b.matnr,C.vbtyp,c.fkart,c.fktyp, marm_from.umren, marm_to.umren;


*--- Previous Year Sale - As on previous year date
 prey_tot_sale =  SELECT a.mandt , substring(a.prodh,1,6) as prod_h, b.matnr,
                    0.00 as curry_sale ,
                   CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                   when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                   when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                    CASE WHEN C.vbtyp <> 'N' and C.vbtyp <> 'O' and C.vbtyp <> 'S' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3) )
                      WHEN C.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                      WHEN C.vbtyp = 'O' and c.fkart = 'ZRTD' THEN
                         cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                      WHEN  c.vbtyp = 'S'  and C.fkart = 'S2' AND C.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                     END
                   end as  prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on a.mandt = b.mandt and b.vbeln = c.vbeln
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                   where  a.stufe = '7' and a.prodh like '11%'  and b.vkbur like zone and a.mandt = session_context( 'CLIENT' )
                   and (  c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO' )  and c.vkorg in ( 1000 , 1001)
                   and c.fkdat between py_first_date and py_last_date
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where  vkorg in ( 1000 , 1001)
                   and ( fkart = 'ZGST' or fkart = 'YSTO' ) and  fkdat between py_first_date and py_last_date   )   )
                   group by a.mandt, substring(a.prodh,1,6) ,b.matnr,C.vbtyp,c.fkart,C.fktyp, marm_from.umren, marm_to.umren;

 prod_total_sale =  select a.mandt, a.prod_h, a.matnr ,a.curry_sale,a.prey_sale from :curry_tot_sale as a
                    UNION all
                   select b.mandt, b.prod_h, b.matnr ,b.curry_sale,b.prey_sale from :prey_tot_sale as b;

 final_sale =   select a.mandt, a.prod_h,sum( a.curry_sale) as curry_sale ,sum(a.prey_sale) as prey_sale
                 from :prod_total_sale as a group by a.mandt , a.prod_h;


**-- Target for current year
 t_target = select a.mandt, a.prod_typ , a.begda , a.endda , cast(sum(a.fkimg) as DEC (18,3) ) as fkimg  from zo2c_target_val as a
               left outer join :final_sale as b on a.prod_typ = b.prod_h
               where prod_cat = '11' and  zon = p_zone and  a.begda BETWEEN cy_first_date and mth_first_date and a.endda <=  mth_last_date
               group by a.mandt, a.prod_typ, a.begda , a.endda ;


 seg_target =  select mandt, prod_typ , fkimg ,
               case when a.begda >= cy_first_date and a.endda <= mth_last_date THEN
                        a.fkimg else
                        0 end as curry_trgt
                        from :t_target as a;

 tot_trgt = select mandt, prod_typ, sum(curry_trgt) as curry_trgt from :seg_target GROUP BY mandt, prod_typ;

 it_final =   SELECT  a.mandt, a.prod_typ , b.prey_sale , b.curry_sale , a.curry_trgt
                 from :tot_trgt as  a
                 left OUTER join :final_sale as b on a.prod_typ = b.prod_h;

 final_oil_sale =   SELECT DISTINCT a.mandt ,substring(a.prod_typ,5,2) as prod_h,  upper( b.vtext ) as product_name, sum(a.prey_sale) as prey_sale , sum(a.curry_sale) as curry_sale  ,
                    sum(a.curry_trgt ) as  curry_trgt from :it_final  as a INNER join t179t as b on a.prod_typ = b.prodh and a.mandt = b.mandt
                    GROUP BY a.mandt, substring(a.prod_typ,5,2) , upper( b.vtext );

 total   =  select mandt, sum(prey_sale) as tot_prey_sale, sum(curry_sale) as tot_curry_sale , sum(curry_trgt) as tot_curry_trgt
              from :final_oil_sale group by mandt;

 RETURN SELECT DISTINCT a.mandt, a.prod_h , a.product_name, a.prey_sale , a.curry_sale  ,
                 CASE WHEN a.prey_sale > 0 THEN
                 (a.curry_sale - a.prey_sale) * 100 / a.prey_sale ELSE
                   0
                 END as gew_pr ,
                 a.curry_trgt,

                 CASE WHEN a.curry_trgt > 0 THEN
                 ( a.curry_sale * 100 ) / a.curry_trgt ELSE
                  0  END as ach_pr ,
                 CASE WHEN a.curry_sale > 0 THEN
                 (b.tot_curry_sale / a.curry_sale ) * 100
                 ELSE 0
                 END  as contr,
                 a.prey_sale / cast(fiscal_period as int) as prey_avg,
                 a.curry_sale / cast(fiscal_period as int ) as curry_avg,
                 a.curry_trgt/  cast(fiscal_period as int ) as trgt_avg
                 from :final_oil_sale as a inner join :total as b on a.mandt = b.mandt;


  endmethod.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Static Public Method ZCL_ZO2C_AMDP_SALE_ANALYSIS=>LINE_OIL_WISE_SALE
* +-------------------------------------------------------------------------------------------------+
* +--------------------------------------------------------------------------------------</SIGNATURE>
  METHOD : line_oil_wise_sale BY DATABASE FUNCTION FOR HDB LANGUAGE SQLSCRIPT
                  OPTIONS READ-ONLY USING t179 ausp vbrk vbrp marm zo2c_target_val ififyearperiod t179t .

*  OutPut Shown in 'MT' Unit

    declare v1 varchar(10);
    declare v2 varchar(10);
    declare v3 varchar(10);
    declare v4 varchar(10);
    declare v5 varchar(10);
    declare mth_first_date varchar(10 );
    declare mth_last_date varchar( 10) ;
    declare mth_first_date1 date;
    declare mth_last_date1 date ;
    declare pymth_first_date varchar(8) ;
    declare pymth_last_date varchar(8) ;
    declare py_mth_first_date varchar(8) ;
    declare py_last_date varchar(8) ;
    declare curr_fiscal_year varchar( 4) ;
    declare pre_fiscal_year varchar( 4) ;
    declare cy_first_date varchar(8);
    declare py_first_date varchar(8);
    declare tot_curr_year_sale decimal;
    declare fiscal_period numeric;
    declare pfy_mth_last_date date;


    declare mycond CONDITION FOR sql_error_code 10001;
    declare EXIT HANDLER FOR mycond signal mycond SET message_text = 'ERROR' ;

 if p_date > session_context('SAP_SYSTEM_DATE') then
    p_date = session_context('SAP_SYSTEM_DATE');
  else
* --- Do Nothing
 end if ;

*-- Current Month First Date
  SELECT add_months(next_day(last_day(p_date)),-1) INTO mth_first_date1 FROM dummy;
*   SELECT add_months(last_day(p_date)) INTO mth_first_date1 FROM dummy;
*--- Current Month Last Date
 SELECT last_day(p_date) INTO mth_last_date1 FROM dummy;

*-- Get Current fiscal year/ Period

  SELECT DISTINCT fiscalyear , fiscalperiod INTO curr_fiscal_year,fiscal_period FROM ififyearperiod
      WHERE fiscalyearvariant = 'V3' AND  fiscalperiodstartdate = mth_first_date1 AND fiscalperiodenddate =  mth_last_date1;


    pre_fiscal_year = curr_fiscal_year - 1;


*-- Get previous fiscal year last date
    SELECT DISTINCT fiscalperiodstartdate, fiscalperiodenddate INTO pymth_first_date , pymth_last_date FROM ififyearperiod
        WHERE fiscalyearvariant = 'V3' AND fiscalyear = :pre_fiscal_year AND fiscalperiod = :fiscal_period
                                AND mandt = session_context( 'CLIENT' );

    cy_first_date = concat(  curr_fiscal_year,'0401' );
    py_first_date = concat(  pre_fiscal_year,'0401' );

*   Convert to YYYYMMDD
    v1 = cast(mth_first_date1 as varchar);   /*  convet to yyyymmdd format */
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_first_date = concat( v5,v4);
*   Convert to YYYYMMDD
    v1 = cast(mth_last_date1 as varchar);  /*  convet to yyyymmdd format */
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_last_date = concat( v5,v4);



* Previous year date for Current Year 29.02.YYYY
    IF p_date = mth_last_date then
      py_last_date = pymth_last_date;
    ELSE
      v1 = cast(p_date as varchar);
      v2 = substring(v1,1,4) - 1 ;
      v3 = substring(v1,5,4);
       py_last_date = concat( v2,v3 );
    END if;

*--- Current Year sale - As on Date

   cy_tot_sale =  SELECT a.mandt , d.atwrt as line, substring(a.prodh,1,6) as prod_h, b.matnr,
                   0.000 as  curry_mth_sale,
                    CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                        when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                        when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                        CASE WHEN C.vbtyp <> 'N' and C.vbtyp <> 'O' and C.vbtyp <> 'S' THEN
                          cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as dec (18,3) )
                         WHEN C.vbtyp = 'N'THEN
                         cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                        WHEN C.vbtyp = 'O' AND c.fkart = 'ZRTD' THEN
                           cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                        WHEN  C.vbtyp = 'S' AND C.fkart = 'S2' AND C.fktyp = 'L' THEN
                         cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                       END
                    end as curry_sale,
                    0.000 as  prey_mth_sale,
                    0.000 as prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on a.mandt = b.mandt and b.vbeln = c.vbeln
                   inner join ausp as d ON a.mandt = d.mandt and d.objek = b.matnr and d.atinn = '0000000002'
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and  /*  */
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and /*  */
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                    and a.mandt = session_context( 'CLIENT' )
                    where  a.stufe = '7' and a.prodh like '11%' and  c.vbtyp <> 'P'
                   and (c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST'AND C.fkart <> 'YSTO')
                   and c.vkorg in ( 1000 , 1001)  and c.fkdat between cy_first_date and p_date
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
                   and ( fkart = 'ZGST' or fkart = 'YSTO' )  and  fkdat between cy_first_date and p_date   )   )
                   group by a.mandt, d.atwrt,substring(a.prodh,1,6),b.matnr,C.vbtyp, c.fkart , C.fktyp, marm_from.umren, marm_to.umren;



*--- Previous Year Sale - As on previous year date
  py_tot_sale =  SELECT a.mandt , d.atwrt as line, substring(a.prodh,1,6) as prod_h, b.matnr,
                     00 as  curry_mth_sale,
                    0.00 as curry_sale ,
                    0.00 as  prey_mth_sale,
                    CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                        when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                        when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                        CASE WHEN C.vbtyp <> 'N' and C.vbtyp <> 'O' and C.vbtyp <> 'S' THEN
                            cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as dec (18,3) )
                          WHEN C.vbtyp = 'N'THEN
                         cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                        WHEN C.vbtyp = 'O' AND c.fkart = 'ZRTD' THEN
                          cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                        WHEN  C.vbtyp = 'S'  AND C.fkart = 'S2' AND C.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                      end
                     end as  prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on a.mandt = b.mandt and b.vbeln = c.vbeln
                   inner join ausp as d ON a.mandt = d.mandt and d.objek = b.matnr and d.atinn = '0000000002'
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and  /*  */
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and /*  */
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                    and a.mandt = session_context( 'CLIENT' )
                    where  a.stufe = '7' and a.prodh like '11%' and  c.vbtyp <> 'P'
                   and (c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' OR C.fkart <> 'YSTO')
                   and c.vkorg in ( 1000 , 1001)
                   and c.fkdat between py_first_date and  py_last_date
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
                   and ( fkart = 'ZGST' or fkart = 'YSTO' )  and  fkdat between py_first_date and py_last_date  )   )
                   group by a.mandt, d.atwrt,substring(a.prodh,1,6) ,b.matnr,C.vbtyp,c.fkart,C.fktyp, marm_from.umren, marm_to.umren;



*-- Sale in  Current Year Month and Previous Year Month
mth_tot_sale  =  SELECT a.mandt , d.atwrt as line,  substring(a.prodh,1,6) as prod_h, b.matnr,
                 CASE when ( marm_to.umren   = 0 or marm_to.umren   is null or marm_from.umren = 0 or marm_from.umren is NULL ) then 0.000
                      when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                      case when c.fkdat BETWEEN mth_first_date and p_date AND  ( c.vbtyp <> 'N' and  c.vbtyp <> 'O' AND c.vbtyp <> 'S' ) THEN
                        cast( sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3) )
                        when c.fkdat BETWEEN mth_first_date and p_date AND  ( c.vbtyp = 'N' OR  c.vbtyp = 'O' OR c.vbtyp = 'S' ) THEN
                            CASE WHEN  c.vbtyp = 'N' THEN
                            cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC(18,3) )
                            WHEN c.vbtyp = 'O' AND C.fkart = 'ZRTD'THEN
                              cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC(18,3) )
                            when c.vbtyp = 'S' AND c.fkart = 'S2' AND C.fktyp = 'L' THEN
                              cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )   as DEC(18,3) )
                            END
                        END
                  end as curry_mth_sale ,
                  0.00 as curry_sale ,

                 CASE when ( marm_to.umren   = 0 or marm_to.umren   is null or marm_from.umren = 0 or marm_from.umren is NULL ) then 0.000
                    when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                     case when c.fkdat BETWEEN pymth_first_date and py_last_date AND  ( c.vbtyp <> 'N' and  c.vbtyp <> 'O' and  c.vbtyp <> 'S' ) THEN
                       cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3) )
                        when c.fkdat BETWEEN pymth_first_date and py_last_date AND  ( c.vbtyp = 'N' OR  c.vbtyp = 'O' OR  c.vbtyp = 'S' ) THEN
                            CASE WHEN  c.vbtyp = 'N' THEN
                            cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC(18,3) )
                            WHEN c.vbtyp = 'O'  AND C.fkart = 'ZRTD'THEN
                              cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC(18,3) )
                            when c.vbtyp = 'S' AND c.fkart = 'S2' AND C.fktyp = 'L' THEN
                              cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC(18,3) )
                            END
                        END
                  end as prey_mth_sale,
                  0.00 as  prey_sale
                 from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                 inner join vbrk as c on b.vbeln = c.vbeln
                 inner join ausp as d ON a.mandt = d.mandt and d.objek = b.matnr and d.atinn = '0000000002'
                 left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                 marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                 left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' )  and
                 marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                 where  a.stufe = '7' and a.prodh like '11%'  and a.mandt = session_context( 'CLIENT' )
                 and c.vbtyp <> 'P' AND ( c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO') and c.vkorg in ( 1000 , 1001)
                 and (  C.fkdat between mth_first_date and p_date or C.fkdat between pymth_first_date and py_last_date )
                 and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
                 and (  fkart = 'ZGST' or fkart = 'YSTO' ) and (fkdat between mth_first_date and p_date or fkdat between pymth_first_date and py_last_date) )   )
                 group by a.mandt, d.atwrt, substring(a.prodh,1,6),b.matnr,b.vrkme,c.vbtyp, C.fkart ,C.fktyp , marm_from.umren, marm_to.umren, c.fkdat;


*session_context( 'CLIENT' )

all_sale =    select a.mandt , a.line, a.prod_h, a.matnr,  a.curry_mth_sale, a.curry_sale , a.prey_mth_sale, a.prey_sale from :cy_tot_sale as a
                 union all
                 select b.mandt , b.line, b.prod_h, b.matnr , b.curry_mth_sale, b.curry_sale , b.prey_mth_sale, b.prey_sale from :py_tot_sale as b
                 union all
                 select c.mandt , c.line, c.prod_h, c.matnr ,  c.curry_mth_sale, c.curry_sale , c.prey_mth_sale, c.prey_sale from :mth_tot_sale as c;

*-- Total Sale in Curr. Year and Input Month , Previous Year ,Pre. Month
total_sale =  select DISTINCT a.mandt, a.line, substring(a.prod_h,1,6) as prod_h, sum(a.curry_mth_sale) as curry_mth_sale,
                 sum(curry_sale) as curr_year_sale , sum(prey_mth_sale ) AS prey_mth_sale ,  sum(prey_sale ) as  pre_year_sale
                 from :all_sale as a where a.prod_h is NOT NULL
                 group by a.mandt, a.line, substring( a.prod_h,1,6);


*line_w_tot_sale = select DISTINCT a.mandt, a.line, 'STOT' as prod_h, sum(a.curry_mth_sale) as curry_mth_sale,
*                 sum(curry_sale) as curr_year_sale , sum(prey_mth_sale ) AS prey_mth_sale ,  sum(prey_sale ) as  pre_year_sale
*                 from :all_sale as a where a.prod_h is NOT NULL
*                 group by a.mandt, a.line;

*final_sale = select mandt , line , prod_h , curry_mth_sale, curr_year_sale, prey_mth_sale, pre_year_sale from :total_sale
*              union
*             select mandt , line , prod_h ,curry_mth_sale, curr_year_sale, prey_mth_sale, pre_year_sale from:line_w_tot_sale;


**-- Target for current year
t_target = select a.mandt, a.atwrt, a.prod_typ , a.begda , a.endda , cast(sum(a.fkimg) as DEC (18,3) ) as fkimg  from zo2c_target_val as a
            left outer join :total_sale as b on a.atwrt = b.line and  a.prod_typ = b.prod_h and a.mandt = session_context( 'CLIENT' )
            where prod_cat = '11' and  a.begda BETWEEN cy_first_date and mth_first_date and a.endda <=  mth_last_date
            group by a.mandt , a.atwrt, a.prod_typ, a.begda , a.endda ;


seg_target = select a.mandt, a.atwrt, a.prod_typ, fkimg ,
                  case when a.begda >= cy_first_date and a.endda <= mth_last_date THEN
                     a.fkimg else
                     0 end as curry_trgt,
                    case when a.begda >= mth_first_date and a.endda <= mth_last_date THEN
                     a.fkimg  else
                     0 end as curry_mth_trgt,
                    case when a.begda >= py_first_date and a.endda <= pymth_last_date THEN
                     a.fkimg else
                     0 end as  prey_trgt,
                     case when a.begda >= pymth_first_date and a.endda <= pymth_last_date THEN
                     a.fkimg else
                     0 end as  prey_mth_trgt
                     from :t_target as a  ;

*
total_target = select mandt, atwrt, prod_typ , sum(curry_trgt ) as curry_target, sum(curry_mth_trgt) as curry_mth_trgt ,
                     sum(prey_trgt) as prey_target, sum( prey_mth_trgt) from :seg_target
                     GROUP BY mandt, atwrt, prod_typ;


it_final =  SELECT a.mandt , a.atwrt as line ,  a.prod_typ as prod_h ,
              b.curry_mth_sale, b.curr_year_sale , b.pre_year_sale ,
               b.prey_mth_sale, curry_target, a.curry_mth_trgt
              from :total_target as a
              left OUTER join :total_sale as b on a.atwrt = b.line
               and  a.prod_typ = b.prod_h;


final_sale = SELECT  b.mandt , a.line, substring( a.prod_h,5,2) as prod_h ,upper( b.vtext ) as product_name ,
              sum(a.curry_mth_sale) as curry_mth_sale , sum(a.curr_year_sale) as curr_year_sale ,sum(a.pre_year_sale) as pre_year_sale,
              sum(a.prey_mth_sale) as prey_mth_sale, sum(a.curry_target) as curry_target, sum(a.curry_mth_trgt) as curry_mth_trgt
              from  :it_final as a INNER join t179t as b on a.prod_h = b.prodh and a.mandt = b.mandt
              group by b.mandt, a.line ,substring(a.prod_h,5,2), upper( b.vtext )  ;


it_final_total =  SELECT  mandt,  sum(curry_mth_sale) as tot_cy_mth_sale, sum(curr_year_sale) as  tot_cy_sale ,
                   sum(pre_year_sale) as tot_py_sale , sum(prey_mth_sale) as tot_py_mth_sale, sum(curry_target) as tot_cy_trgt ,
                   sum(curry_mth_trgt) as tot_cy_mth_trgt from :it_final  GROUP BY mandt;


RETURN SELECT DISTINCT a.mandt, a.line, a.prod_h, a.product_name, a.curry_mth_trgt , a.curry_mth_sale,
                     case when  a.curry_mth_trgt > 0 then
                      ( a.curry_mth_sale / a.curry_mth_trgt ) * 100
                       else 0
                       end as ach ,
                      a.prey_mth_sale,

                     case when a.prey_mth_sale > 0 then
                     (  ( a.curry_mth_sale - a.prey_mth_sale ) * 100  ) /a.prey_mth_sale
                    else
                     100 end as grw ,
                    a.curry_target  as curry_trgt ,
                    a.curr_year_sale,
                    case when  a.curry_target > 0 then
                      (a.curr_year_sale * 100 ) / a.curry_target
                    else 0.000 end as y_ach ,
                      a.pre_year_sale,
                      case when pre_year_sale > 0 then
                       (a.curr_year_sale - pre_year_sale ) * 100 / a.pre_year_sale
                     else
                     100 end as y_grw
                     FROM :final_sale as a
                     left OUTER join :it_final_total as b on a.mandt = b.mandt;


  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Static Public Method ZCL_ZO2C_AMDP_SALE_ANALYSIS=>LINE_ZONE_MFS_SALE
* +-------------------------------------------------------------------------------------------------+
* +--------------------------------------------------------------------------------------</SIGNATURE>
  method : line_zone_mfs_sale BY DATABASE FUNCTION FOR HDB LANGUAGE SQLSCRIPT
                  OPTIONS READ-ONLY USING ausp vbrk vbrp marm zo2c_target_val ififyearperiod knvv.


    declare v1 varchar(10);
    declare v2 varchar(10);
    declare v3 varchar(10);
    declare v4 varchar(10);
    declare v5 varchar(10);
    declare mth_first_date varchar(10 );
    declare mth_last_date varchar( 10) ;
    declare mth_first_date1 date;
    declare mth_last_date1 date ;
    declare pymth_first_date varchar(8) ;
    declare pymth_last_date varchar(8) ;
    declare pymth_date varchar(8) ;
    declare py_mth_first_date varchar(8) ;
    declare py_last_date varchar(8) ;
    declare curr_fiscal_year varchar( 4) ;
    declare pre_fiscal_year varchar( 4) ;
    declare cy_first_date varchar(8);
    declare py_first_date varchar(8);
    declare tot_curr_year_sale decimal;
    declare zone varchar(2);
    declare fiscal_period numeric;


 if p_date > session_context('SAP_SYSTEM_DATE') then
    p_date = session_context('SAP_SYSTEM_DATE');
  else
* --- Do Nothing
 end if ;

*-- Current Month First Date
    SELECT add_months(next_day(last_day(p_date)),-1) INTO mth_first_date1 FROM dummy;
*   SELECT add_months(last_day(p_date)) INTO mth_first_date1 FROM dummy;
*--- Current Month Last Date
    SELECT last_day(p_date) INTO mth_last_date1 FROM dummy;

*-- Get Current fiscal year/ Period
    SELECT DISTINCT fiscalyear , fiscalperiod INTO curr_fiscal_year,fiscal_period FROM ififyearperiod
        WHERE fiscalyearvariant = 'V3' AND  fiscalperiodstartdate = mth_first_date1 AND fiscalperiodenddate =  mth_last_date1
                                                         AND mandt = session_context( 'CLIENT' );

      pre_fiscal_year = curr_fiscal_year - 1;


*-- Get previous fiscal year last date
    SELECT DISTINCT fiscalperiodstartdate, fiscalperiodenddate INTO pymth_first_date, pymth_last_date FROM ififyearperiod
        WHERE fiscalyearvariant = 'V3' AND fiscalyear = :pre_fiscal_year AND fiscalperiod = :fiscal_period
                                AND mandt = session_context( 'CLIENT' );


* First Date
    cy_first_date = concat(  curr_fiscal_year,'0401' );
    py_first_date = concat(  pre_fiscal_year,'0401' );

*   Convert to YYYYMMDD
    v1 = cast(mth_first_date1 as varchar);
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_first_date = concat( v5,v4);

*   Convert to YYYYMMDD
    v1 = cast(mth_last_date1 as varchar);
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_last_date = concat( v5,v4);

    IF p_date = mth_last_date then
       pymth_date = pymth_last_date;
    ELSE
      v1 = cast(p_date as varchar);
      v2 = substring(v1,1,4) - 1 ;
      v3 = substring(v1,5,4);
       pymth_date = concat( v2,v3 );
    END if;

   zone = concat( p_zone, '%' );

*--- Current Year sale - As on Date
  cy_tot_sale1 =  SELECT a.mandt , c.atwrt as line, b.matnr, a.kunrg,
               CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                 CASE WHEN a.vbtyp <> 'N' and a.vbtyp <> 'O'  AND a.vbtyp <> 'S' THEN
                     cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as dec (18,3) )
                      WHEN a.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                      WHEN a.vbtyp = 'O' and a.fkart = 'ZRTD' THEN
                         cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                      WHEN  a.vbtyp = 'S'  and  a.fkart = 'S2' AND a.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                     end
                    END as curry_sale,
                    0.000 as prey_sale
                    from vbrk as a INNER JOIN vbrp as b ON a.mandt = b.mandt and a.vbeln = b.vbeln
                    inner join ausp as c ON b.mandt = b.mandt and c.objek = b.matnr and c.atinn = '0000000002'
                    left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and  /*  */
                    marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                    left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and /*  */
                    marm_to.matnr   = marm_from.matnr and  marm_to.meinh   = 'MT'
                    and a.mandt = session_context( 'CLIENT' ) and (  b.prodh like '11%' or b.prodh like '12%' )
                    where  a.vbtyp <> 'P'  and  b.vkbur like zone
                   and (a.fkart <> 'ZCEX' AND  a.fkart <> 'ZGST'AND a.fkart <> 'YSTO')
                   and a.vkorg in ( 1000 , 1001)   and a.fkdat between cy_first_date and p_date and a.vtweg <> '15'
                   group by a.mandt, c.atwrt,b.matnr,a.kunrg , a.vbtyp ,a.fkart ,a.fktyp, marm_from.umren, marm_to.umren;


*-- Get all Customer for L5 group
 lt_kunnr = select distinct mandt , kunnr from knvv where  kvgr5 = 'L5' and  vkorg in ( '1000' , '1001' )
              and mandt = session_context( 'CLIENT');


**-- Excluding L5 Custromer Record
* cy_line_ex_5 =    select distinct a.mandt , a.line as line, a.matnr,
*                   a.curry_sale,
*                   a.prey_sale
*                   from :cy_tot_sale1 as a left OUTER join :lt_kunnr as b on a.mandt = b.mandt
*                                                 and a.kunrg <> b.kunnr;

*--Mapping L5 Custromer Record
 cy_tot_sale =    select  a.mandt ,
                    CASE WHEN a.kunrg = b.kunnr then
                    'LINE 5' ELSE
                    a.line END as line,
                    a.matnr,
                    a.curry_sale,
                    a.prey_sale from :cy_tot_sale1 as a
                   left outer JOIN :lt_kunnr as b on a.mandt = b.mandt and a.kunrg = b.kunnr;

* cy_tot_sale =  select distinct a.mandt , a.line as line, a.matnr , a.curry_sale, a.prey_sale FROM :cy_line_ex_5 AS a
*                UNION
*                select distinct b.mandt , b.line as line, b.matnr , b.curry_sale , b.prey_sale FROM :cy_l5 AS b;

*--- Previous Year Sale - As on previous year date
 py_tot_sale1 =    SELECT a.mandt , c.atwrt as line, b.matnr, a.kunrg,
                 0.00 as curry_sale,
               CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                 CASE WHEN a.vbtyp <> 'N' and a.vbtyp <> 'O'  AND a.vbtyp <> 'S'THEN
                     cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as dec (18,3) )
                       WHEN a.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                     WHEN a.vbtyp = 'O' and a.fkart = 'ZRTD' THEN
                          cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                     WHEN  a.vbtyp = 'S'  and  a.fkart = 'S2' AND a.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                     ELSE 0.00 END
                    end As prey_sale
                    from vbrk as a INNER JOIN vbrp as b ON a.mandt = b.mandt and a.vbeln = b.vbeln
                    inner join ausp as c ON b.mandt = b.mandt and c.objek = b.matnr and c.atinn = '0000000002'
                    left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and  /*  */
                    marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                    left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and /*  */
                    marm_to.matnr   = marm_from.matnr and  marm_to.meinh   = 'MT'
                    and a.mandt = session_context( 'CLIENT' )
                    where  a.vbtyp <> 'P' and b.vkbur like zone and (  b.prodh like '11%' or b.prodh like '12%' )
                    and (a.fkart <> 'ZCEX' AND  a.fkart <> 'ZGST'AND a.fkart <> 'YSTO')
                    and a.vkorg in ( 1000 , 1001) and a.fkdat between py_first_date and  pymth_date and a.vtweg <> '15'
                   group by a.mandt, c.atwrt,b.matnr,a.kunrg , a.vbtyp ,  a.fkart, a.fktyp, marm_from.umren, marm_to.umren;


 py_tot_sale =    select  a.mandt ,
                    CASE WHEN a.kunrg = b.kunnr then
                    'LINE 5' ELSE
                    a.line END as line,
                    a.matnr,
                    a.curry_sale,
                    a.prey_sale from :py_tot_sale1 as a
                   left outer JOIN :lt_kunnr as b on a.mandt = b.mandt and a.kunrg = b.kunnr;

**-- Line 5 DATA
* py_l5 =   select distinct a.mandt , 'L5' as line, a.matnr,
*               CASE when a.kunrg = b.kunnr then
*                  a.prey_sale
*                else  0.00
*                end as prey_sale,
*                0.00 as curry_sale
*                from :cy_tot_sale1 as a inner join :lt_kunnr as b on a.mandt = b.mandt
*                and  a.kunrg = b.kunnr AND a.prey_sale > 0 ;
*
* py_tot_sale =  select distinct a.mandt , a.line as line, a.matnr , a.curry_sale, a.prey_sale FROM :py_line_ex_5 AS a
*                UNION
*                select distinct b.mandt , b.line as line, b.matnr , b.curry_sale , b.prey_sale FROM :py_l5 AS b;

 line_total_sale =  select a.mandt, a.line, a.matnr ,a.curry_sale,a.prey_sale from :cy_tot_sale as a
                      UNION all
                    select b.mandt, b.line, b.matnr ,b.curry_sale,b.prey_sale from :py_tot_sale as b;

final_sale =   select a.mandt, a.line,sum( a.curry_sale) as curry_sale ,sum(a.prey_sale) as prey_sale
                 from :line_total_sale as a group by a.mandt, a.line;


**-- Target for current year
 t_target = select a.mandt, a.atwrt, a.begda , a.endda , cast(sum(a.fkimg) as DEC (18,3) ) as fkimg  from zo2c_target_val as a
               left outer join :final_sale as b on a.atwrt = b.line and a.mandt = session_context( 'CLIENT' )
               where a.mandt = session_context( 'CLIENT' ) AND  a.zon = p_zone
               AND a.begda BETWEEN cy_first_date and mth_first_date and a.endda <=  mth_last_date
               group by a.mandt, a.atwrt, a.begda , a.endda ;


 seg_target = select mandt, atwrt , fkimg ,
              case when a.begda >= cy_first_date and a.endda <= mth_last_date THEN
                        a.fkimg else
                        0 end as curry_trgt
                        from :t_target as a;

 tot_trgt = select mandt, atwrt, sum(curry_trgt) as curry_trgt from :seg_target GROUP BY mandt, atwrt;



 it_final =   SELECT  a.mandt , a.atwrt as line  , b.prey_sale , b.curry_sale  , a.curry_trgt
                 from :tot_trgt as a LEFT OUTER join :final_sale as b on a.atwrt = b.line;

 total   =  select mandt, sum(prey_sale) as tot_prey_sale, sum(curry_sale) as tot_curry_sale , sum(curry_trgt) as tot_curry_trgt
              from :it_final group by mandt;

 RETURN SELECT DISTINCT a.mandt, a.line , a.curry_trgt,a.curry_sale,
                 CASE WHEN a.curry_sale > 0 THEN
                 (b.tot_curry_sale / a.curry_sale ) * 100
                 ELSE 0
                 END  as contr,
                 CASE WHEN a.curry_trgt > 0 THEN
                 ( a.curry_sale * 100 ) / a.curry_trgt ELSE
                  0  END as ach_pr ,
                 a.prey_sale ,
                 CASE WHEN a.prey_sale > 0 THEN
                 (a.curry_sale - a.prey_sale) * 100 / a.prey_sale ELSE
                   0
                 END as grw_pr ,
                 a.curry_trgt/  cast(fiscal_period as int ) as trgt_avg,
                 a.curry_sale / cast(fiscal_period as int ) as curry_avg,
                 a.prey_sale / cast(fiscal_period as int) as prey_avg
                 from :it_final as a inner join :total as b on a.mandt = b.mandt;

  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Static Public Method ZCL_ZO2C_AMDP_SALE_ANALYSIS=>ALL_LINE_WISE_MFS_SALE
* +-------------------------------------------------------------------------------------------------+
* +--------------------------------------------------------------------------------------</SIGNATURE>
  method : all_line_wise_mfs_sale BY DATABASE FUNCTION FOR HDB LANGUAGE SQLSCRIPT
                  OPTIONS READ-ONLY USING ausp vbrk vbrp marm zo2c_target_val ififyearperiod knvv.

* ALL India Line Wise Sale - MFS Report
*_____________________________________________________________________________________________________
*Line   | Nov 2017                              |  April  to Nov 2017                                 |
*_______|_______________________________________|_____________________________________________________|
*         Trgt    17-18|  Ach %   16-17 | Grw % |  Trgt    17-18   %Contr  Ach %   16-17   Grw %
*_______|_____|________|_________|______|_______|_____________|_______|________|______|________|______|

    declare v1 varchar(10);
    declare v2 varchar(10);
    declare v3 varchar(10);
    declare v4 varchar(10);
    declare v5 varchar(10);
    declare mth_first_date varchar(10 );
    declare mth_last_date varchar( 10) ;
    declare mth_first_date1 date;
    declare mth_last_date1 date ;
    declare pymth_date varchar( 8);
    declare pymth_first_date varchar(8) ;
    declare pymth_last_date varchar(8) ;
    declare py_mth_first_date varchar(8) ;
    declare py_last_date varchar(8) ;
    declare curr_fiscal_year varchar( 4) ;
    declare pre_fiscal_year varchar( 4) ;
    declare cy_first_date varchar(8);
    declare py_first_date varchar(8);
    declare tot_curr_year_sale decimal;
    declare zone varchar(2);
    declare fiscal_period numeric;

 if p_date > session_context('SAP_SYSTEM_DATE') then
    p_date = session_context('SAP_SYSTEM_DATE');
  else
* --- Do Nothing
 end if ;

*-- Current Month First Date
    SELECT add_months(next_day(last_day(p_date)),-1) INTO mth_first_date1 FROM dummy;
*   SELECT add_months(last_day(p_date)) INTO mth_first_date1 FROM dummy;
*--- Current Month Last Date
    SELECT last_day(p_date) INTO mth_last_date1 FROM dummy;

*-- Get Current fiscal year/ Period
    SELECT DISTINCT fiscalyear , fiscalperiod INTO curr_fiscal_year,fiscal_period FROM ififyearperiod
        WHERE fiscalyearvariant = 'V3' AND  fiscalperiodstartdate = mth_first_date1 AND fiscalperiodenddate =  mth_last_date1
                                                         AND mandt = session_context( 'CLIENT' );

      pre_fiscal_year = curr_fiscal_year - 1;

*-- Get previous fiscal year last date
    SELECT DISTINCT fiscalperiodstartdate, fiscalperiodenddate INTO pymth_first_date,pymth_last_date FROM ififyearperiod
        WHERE fiscalyearvariant = 'V3' AND fiscalyear = :pre_fiscal_year AND fiscalperiod = :fiscal_period
                                AND mandt = session_context( 'CLIENT' );


* First Date
    cy_first_date = concat(  curr_fiscal_year,'0401' );
    py_first_date = concat(  pre_fiscal_year,'0401' );

*   Convert to YYYYMMDD
    v1 = cast(mth_first_date1 as varchar);
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_first_date = concat( v5,v4);

*   Convert to YYYYMMDD
    v1 = cast(mth_last_date1 as varchar);
    v2 = substring(v1,1,4);
    v3 = substring(v1,6,2);
    v4 = substring(v1,9,2);
    v5 = concat( v2,v3 );
    mth_last_date = concat( v5,v4);

    IF p_date = mth_last_date then
       pymth_date = pymth_last_date;
    ELSE
      v1 = cast(p_date as varchar);
      v2 = substring(v1,1,4) - 1 ;
      v3 = substring(v1,5,4);
       pymth_date = concat( v2,v3 );
    END if;

*--- Current Year sale - As on Date
  cy_tot_sale1 =  SELECT a.mandt , c.atwrt as line, b.matnr, a.kunrg,a.vbtyp ,
               0.00 as curry_mth_sale,
               CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                CASE WHEN a.vbtyp <> 'N' and a.vbtyp <> 'O' and a.  vbtyp <> 'S'  THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as dec (18,3) )
                     WHEN a.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                     WHEN a.vbtyp = 'O' and a.fkart = 'ZRTD' THEN
                          cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                     WHEN  a.vbtyp = 'S'  and  a.fkart = 'S2' AND a.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                     END
                    end as curry_sale,
                    0.000 as prey_mth_sale,
                    0.000 as prey_sale
                    from vbrk as a INNER JOIN vbrp as b ON a.mandt = b.mandt and a.vbeln = b.vbeln
                    inner join ausp as c ON b.mandt = b.mandt and c.objek = b.matnr and c.atinn = '0000000002'
                    left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and  /*  */
                    marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                    left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and /*  */
                    marm_to.matnr   = marm_from.matnr and  marm_to.meinh   = 'MT'
                    and a.mandt = session_context( 'CLIENT' )  where  a.vbtyp <> 'P'
                    and (a.fkart <> 'ZCEX' AND  a.fkart <> 'ZGST'AND a.fkart <> 'YSTO')
                    and a.vkorg in ( 1000 , 1001) and a.vtweg <> '15' and (  b.prodh like '11%' or b.prodh like '12%' )
                    and a.fkdat between cy_first_date and p_date
                    and  a.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
                    and (  fkart = 'ZGST' or fkart = 'YSTO' ) and fkdat between cy_first_date and p_date  )   )
                    group by a.mandt, c.atwrt,b.matnr,a.kunrg, a.vbtyp , a.fkart, a.fktyp, marm_from.umren, marm_to.umren;


*-- Get all all Customer for L5 group 5
 lt_kunnr = select distinct mandt, kunnr from knvv where  kvgr5 = 'L5' and mandt = session_context( 'CLIENT') ;

**-- Excluding L5 Custromer Record
* cy_line_ex_5 =    select  a.mandt , a.line as line, a.matnr,
*                   a.curry_mth_sale,
*                   CASE WHEN a.kunrg = b.kunnr then
*                   0.00 else
*                   a.curry_sale end as curry_sale,
*                   a.prey_mth_sale, a.prey_sale from :cy_tot_sale1 as a
*                   left outer JOIN :lt_kunnr as b on a.mandt = b.mandt and a.kunrg = b.kunnr;


*-- Mapping L5 Custromer Record
 cy_tot_sale =    select  a.mandt ,
                    CASE WHEN a.kunrg = b.kunnr then
                    'LINE 5' ELSE
                    a.line END as line,
                    a.matnr,
                   a.curry_mth_sale,
                   a.curry_sale,
                   a.prey_mth_sale, a.prey_sale from :cy_tot_sale1 as a
                   left outer JOIN :lt_kunnr as b on a.mandt = b.mandt and a.kunrg = b.kunnr;



**-- Line 5 DATA
* cy_l5 =   select a.mandt , 'L5' as line, a.matnr, a.curry_mth_sale,
*               CASE when a.kunrg = b.kunnr then
*                  a.curry_sale
*                else  0.00
*                end as curry_sale,
*                0.00 as prey_mth_sale,
*                0.00 as prey_sale
*                from :cy_tot_sale1 as a inner join :lt_kunnr as b on a.mandt = b.mandt
*                and  a.kunrg = b.kunnr AND a.curry_sale > 0 ;

* cy_tot_sale =  select a.mandt , a.line as line, a.matnr ,a.curry_mth_sale, a.curry_sale, a.prey_mth_sale, a.prey_sale FROM :cy_line_ex_5 AS a
*                UNION all
*                select b.mandt , b.line as line, b.matnr , b.curry_mth_sale, b.curry_sale, b.prey_mth_sale, b.prey_sale FROM :cy_l5 AS b;

*--- Previous Year Sale - As on previous year date
 py_tot_sale1 =   SELECT a.mandt , c.atwrt as line, b.matnr, a.kunrg ,
                  0.00 as curry_mth_sale,
                  0.00 as curry_sale,
                  0.00 as prey_mth_sale,
                  CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                   when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                   when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                     CASE WHEN a.vbtyp <> 'N' and a.vbtyp <> 'O'  AND a.vbtyp <> 'S' THEN
                      cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as dec (18,3) )
                     WHEN a.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                     WHEN a.vbtyp = 'O' and a.fkart = 'ZRTD' THEN
                          cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                     WHEN  a.vbtyp = 'S'  and  a.fkart = 'S2' AND a.fktyp = 'L' THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                     END
                    end as prey_sale
                    from vbrk as a INNER JOIN vbrp as b ON a.mandt = b.mandt and a.vbeln = b.vbeln
                    inner join ausp as c ON b.mandt = b.mandt and c.objek = b.matnr and c.atinn = '0000000002'
                    left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and  /*  */
                    marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                    left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and /*  */
                    marm_to.matnr   = marm_from.matnr and  marm_to.meinh   = 'MT'
                    and a.mandt = session_context( 'CLIENT' ) where  a.vbtyp <> 'P'
                   and (a.fkart <> 'ZCEX' AND  a.fkart <> 'ZGST'AND a.fkart <> 'YSTO')
                   and a.vkorg in ( 1000 , 1001) and a.vtweg <> '15' and (  b.prodh like '11%' or b.prodh like '12%' )
                   and a.fkdat between py_first_date and pymth_date
*                    and  a.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
*                   and  (  fkart = 'ZGST' or fkart = 'YSTO' ) and fkdat between py_first_date and pymth_date  )   )
                   group by a.mandt, c.atwrt,b.matnr,a.kunrg ,a.vbtyp, a.fkart , a.fktyp, marm_from.umren, marm_to.umren;


*-- Excluding L5 Custromer Record
* py_line_ex_5 =   select  a.mandt , a.line as line, a.matnr,
*                   a.curry_mth_sale, a.curry_sale, a.prey_mth_sale,
*                   a.prey_sale from :py_tot_sale1 as a left outer join :lt_kunnr as b
*                   on a.mandt = b.mandt and a.kunrg <> b.kunnr;

*-- Mapping L5 Custromer Record
 py_tot_sale =    select  a.mandt ,
                    CASE WHEN a.kunrg = b.kunnr then
                    'LINE 5' ELSE
                    a.line END as line,
                    a.matnr,
                   a.curry_mth_sale,
                    a.curry_sale,
                   a.prey_mth_sale, a.prey_sale from :py_tot_sale1 as a
                   left outer JOIN :lt_kunnr as b on a.mandt = b.mandt and a.kunrg = b.kunnr;


*-- Line 5 DATA
*  py_l5 =    select a.mandt , 'L5' as line, a.matnr,
**            CASE when a.kunrg = b.kunnr then
*              a.curry_mth_sale, a.curry_sale,
*              a.prey_mth_sale, a.prey_sale
*                from :cy_tot_sale1 as a inner join :lt_kunnr as b on a.mandt = b.mandt
*                and  a.kunrg = b.kunnr AND a.prey_sale > 0 ;

* py_tot_sale =  select a.mandt , a.line as line, a.matnr ,a.curry_mth_sale, a.curry_sale, a.prey_mth_sale, a.prey_sale FROM :py_line_ex_5 AS a
*                UNION all
*                select  b.mandt , b.line as line, b.matnr ,b.curry_mth_sale , b.curry_sale , b.prey_mth_sale , b.prey_sale FROM :py_l5 AS b;

*-- Sale in  Current Year Month and Previous Year Month
 mth_tot_sale   = SELECT a.mandt , c.atwrt as line, b.matnr, a.kunrg,
                  CASE when ( marm_to.umren   = 0 or marm_to.umren   is null or marm_from.umren = 0 or marm_from.umren is NULL ) then 0.000
                    when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                    case when a.fkdat BETWEEN mth_first_date and p_date AND  ( a.vbtyp <> 'N' and  a.vbtyp <> 'O' and a.vbtyp <> 'S' ) THEN
                     cast( sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3) )
                      WHEN a.fkdat BETWEEN mth_first_date and p_date AND  ( a.vbtyp = 'N' OR  a.vbtyp = 'O' OR a.vbtyp = 'S' ) then
                       case when a.vbtyp = 'N'THEN
                        cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                          WHEN  a.vbtyp = 'O' and a.fkart = 'ZRTD' THEN
                          cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                           WHEN a.vbtyp = 'S'  and  a.fkart = 'S2' AND a.fktyp = 'L'  THEN
                            cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                           end
                         end
                  end as curry_mth_sale ,
                  0.00 as curry_sale ,

                CASE when ( marm_to.umren   = 0 or marm_to.umren   is null or marm_from.umren = 0 or marm_from.umren is NULL ) then 0.000
                    when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                     case when a.fkdat BETWEEN pymth_first_date and pymth_date AND  ( a.vbtyp <> 'N' and  a.vbtyp <> 'O' and a.vbtyp <> 'S' ) THEN
                       cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) as DEC (18,3) )
                       when a.fkdat BETWEEN pymth_first_date and pymth_date AND  ( a.vbtyp = 'N' OR  a.vbtyp = 'O' OR a.vbtyp = 'S' ) THEN
                          case when a.vbtyp = 'N'THEN
                            cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                           WHEN a.vbtyp = 'O' and a.fkart = 'ZRTD' THEN
                             cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) ) * - 1 as DEC (18,3))
                           WHEN  a.vbtyp = 'S'  and  a.fkart = 'S2' AND a.fktyp = 'L' THEN
                             cast(sum (round( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ), 3, round_half_even) )  as DEC (18,3))
                           end
                        end
                  end as prey_mth_sale,
                  0.00 as  prey_sale
                  from vbrk as a inner join vbrp as b ON a.mandt = b.mandt and a.vbeln = b.vbeln
                  inner join ausp as c ON c.mandt = b.mandt and c.objek = b.matnr and c.atinn = '0000000002'
                  left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                  marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                  left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' )  and
                  marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                  where a.mandt = session_context( 'CLIENT' ) and (  b.prodh like '11%' or b.prodh like '12%' )
                  and a.vbtyp <> 'P' AND ( a.fkart <> 'ZCEX' AND  a.fkart <> 'ZGST' and a.fkart <> 'YSTO') and a.vkorg in ( 1000 , 1001)
                  and (  a.fkdat between mth_first_date and p_date or a.fkdat between pymth_first_date and pymth_date )
                  and a.vtweg <> '15'
*                  and  a.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001) and
*                  (fkart = 'ZGST' or fkart = 'YSTO') and ( fkdat between mth_first_date and p_date or a.fkdat between pymth_first_date and pymth_date )  )   )
                  group by a.mandt, c.atwrt,b.matnr,a.kunrg,b.vrkme,a.vbtyp, a.fkart, a.fktyp , marm_from.umren, marm_to.umren, a.fkdat;


*-- Excluding L5 Custromer Record
* mth_line_ex_5 =  select a.mandt , a.line as line, a.matnr,
*                    a.curry_mth_sale, a.curry_sale, a.prey_mth_sale,
*                    a.prey_sale from :mth_tot_sale as a left outer join :lt_kunnr as b
*                    on a.mandt = b.mandt and a.kunrg <> b.kunnr;

*-- Mapping L5 Custromer Record
  mth_sale =    select  a.mandt ,
                    CASE WHEN a.kunrg = b.kunnr then
                    'LINE 5' ELSE
                    a.line END as line,
                    a.matnr,
                   a.curry_mth_sale,
                   a.curry_sale,
                   a.prey_mth_sale, a.prey_sale from :mth_tot_sale as a
                   left outer JOIN :lt_kunnr as b on a.mandt = b.mandt and a.kunrg = b.kunnr;


**-- L5 Customer Data
* mth_l5 =   select a.mandt , 'L5' as line, a.matnr,
*            a.curry_mth_sale, a.curry_sale, a.prey_mth_sale,
*            a.prey_sale from :cy_tot_sale1 as a inner join :lt_kunnr as b
*            on a.mandt = b.mandt and  a.kunrg = b.kunnr AND a.prey_sale > 0 ;
*
* mth_sale =   select a.mandt , a.line as line, a.matnr , a.curry_mth_sale, a.curry_sale, a.prey_mth_sale, a.prey_sale FROM :mth_line_ex_5 AS a
*              UNION all
*              select b.mandt ,b.line as line, b.matnr , b.curry_mth_sale, b.curry_sale , b.prey_mth_sale, b.prey_sale FROM :mth_l5 AS b;



 line_total_sale =  select a.mandt, a.line, a.matnr ,a.curry_mth_sale,a.curry_sale,a.prey_mth_sale,a.prey_sale from :cy_tot_sale as a
                      UNION all
                     select b.mandt, b.line, b.matnr ,b.curry_mth_sale,b.curry_sale,b.prey_mth_sale,b.prey_sale from :py_tot_sale as b
                     union all
                     select c.mandt, c.line, c.matnr ,c.curry_mth_sale,c.curry_sale,c.prey_mth_sale,c.prey_sale from :mth_sale as c;

final_sale =   select a.mandt, a.line,  sum(a.curry_mth_sale ) as curry_mth_sale ,sum( a.curry_sale) as curry_sale,
                 sum(a.prey_mth_sale ) as prey_mth_sale , sum(a.prey_sale) as prey_sale
                 from :line_total_sale as a group by a.mandt, a.line;


**-- Target for current year
 t_target = select a.mandt, a.atwrt, a.begda , a.endda , cast(sum(a.fkimg) as DEC (18,3) ) as fkimg  from zo2c_target_val as a
               left outer join :final_sale as b on a.atwrt = b.line
               where a.mandt = session_context( 'CLIENT' ) and
               a.begda BETWEEN cy_first_date and mth_first_date and a.endda <=  mth_last_date
               group by  a.mandt, a.atwrt, a.begda , a.endda ;


 seg_target = select mandt,  atwrt , fkimg ,
              case when a.begda >= cy_first_date and a.endda <= mth_last_date THEN
               a.fkimg else
              0 end as curry_trgt,
              case when a.begda >= mth_first_date and a.endda <= mth_last_date THEN
               a.fkimg else
              0 end as curry_mth_trgt
              from :t_target as a;

 tot_trgt = select mandt, atwrt, sum(curry_trgt) as curry_trgt ,sum(curry_mth_trgt) as curry_mth_trgt from :seg_target GROUP BY mandt, atwrt;


 it_final =   SELECT a.mandt , a.atwrt as line ,b.curry_mth_sale, b.curry_sale, b.prey_mth_sale, b.prey_sale,
              a.curry_mth_trgt, a.curry_trgt
              from :tot_trgt as a LEFT OUTER join :final_sale as b on a.atwrt = b.line;

 total   =  select mandt, sum(prey_sale) as tot_prey_sale, sum(curry_sale) as tot_curry_sale , sum(curry_trgt) as tot_curry_trgt
              from :it_final group by mandt;


  RETURN SELECT DISTINCT a.mandt, a.line,  a.curry_mth_trgt , a.curry_mth_sale,
                     case when  a.curry_mth_trgt > 0 then
                      cast(( a.curry_mth_sale / a.curry_mth_trgt ) * 100 as DEC (18,3) )
                       else 0
                       end as ach ,
                      a.prey_mth_sale,
                     case when a.prey_mth_sale > 0 then
                     ( ( a.curry_mth_sale - a.prey_mth_sale ) * 100  ) /a.prey_mth_sale
                     else
                     100 end as grw ,
                    a.curry_trgt ,
                    a.curry_sale,
                    case when  tot_curry_sale > 0 then
                     ( a.curry_sale * 100 ) / tot_curry_sale
                     else 0 end as contr,
                    case when  a.curry_trgt > 0 then
                    cast((a.curry_sale * 100 ) / a.curry_trgt as DEC (18,3) )
                    else 0.000 end as y_ach ,
                      a.prey_sale,
                      case when prey_sale > 0 then
                     ( (a.curry_sale - prey_sale ) * 100 ) / a.prey_sale
                     else
                     100 end as y_grw
                     FROM :it_final as a INNER join :total as b on a.mandt = b.mandt;
  ENDMETHOD.


* <SIGNATURE>---------------------------------------------------------------------------------------+
* | Static Public Method ZCL_ZO2C_AMDP_SALE_ANALYSIS=>SALES_DATA_DUMP
* +-------------------------------------------------------------------------------------------------+
* +--------------------------------------------------------------------------------------</SIGNATURE>
  method : sales_data_dump BY DATABASE FUNCTION FOR HDB LANGUAGE SQLSCRIPT
                    OPTIONS READ-ONLY USING t179 vbrk vbrp marm ififyearperiod.


*-- This Method used for sales report Dump with Doc Number
*--- And to Validate data with Doc wise

    declare v1 varchar(10);
     declare v2 varchar(10);
     declare v3 varchar(10);
     declare v4 varchar(10);
     declare v5 varchar(10);
     declare mth_first_date varchar(10 );
     declare mth_last_date varchar( 10) ;
     declare mth_first_date1 date;
     declare mth_last_date1 date ;
     declare pymth_first_date varchar(8) ;
     declare pymth_last_date varchar(8) ;
     declare py_mth_first_date varchar(8) ;
     declare py_last_date varchar(8) ;
     declare cal int;
     declare curr_fiscal_year varchar( 4) ;
     declare pre_fiscal_year varchar( 4) ;
     declare cy_first_date varchar(8);
     declare py_first_date varchar(8);
     declare tot_curr_year_sale decimal;
     declare fiscal_period numeric;
     declare pymth_date varchar(8);
     declare today_date date;
     declare c_table varchar;


  IF p_date > session_context('SAP_SYSTEM_DATE') then
     p_date = session_context('SAP_SYSTEM_DATE');
   ELSE
* --- Do Nothing
  END IF ;

*-- Current Month First Date
   SELECT add_months(next_day(last_day(p_date)),-1) INTO mth_first_date1 FROM dummy;

*--- Current Month Last Date
  SELECT last_day(p_date) INTO mth_last_date1 FROM dummy;


*-- Get Current fiscal year/ Period
     SELECT DISTINCT fiscalyear , fiscalperiod INTO curr_fiscal_year,fiscal_period FROM ififyearperiod
         WHERE fiscalyearvariant = 'V3' AND  fiscalperiodstartdate = mth_first_date1 AND fiscalperiodenddate =  mth_last_date1
                                                          AND mandt = session_context( 'CLIENT' );


**-- Previous Fiscal Year
       pre_fiscal_year = curr_fiscal_year - 1;

*-- Get previous fiscal year last date
     SELECT DISTINCT fiscalperiodstartdate, fiscalperiodenddate INTO pymth_first_date , pymth_last_date FROM ififyearperiod
         WHERE fiscalyearvariant = 'V3' AND fiscalyear = :pre_fiscal_year AND fiscalperiod = :fiscal_period
                                 AND mandt = session_context( 'CLIENT' );


* First Date
     cy_first_date = concat(  curr_fiscal_year,'0401' );
     py_first_date = concat(  pre_fiscal_year,'0401' );

*   Convert to YYYYMMDD
     v1 = cast(mth_first_date1 as varchar);
     v2 = substring(v1,1,4);
     v3 = substring(v1,6,2);
     v4 = substring(v1,9,2);
     v5 = concat( v2,v3 );
     mth_first_date = concat( v5,v4);

*   Convert to YYYYMMDD
     v1 = cast(mth_last_date1 as varchar);
     v2 = substring(v1,1,4);
     v3 = substring(v1,6,2);
     v4 = substring(v1,9,2);
     v5 = concat( v2,v3 );
     mth_last_date = concat( v5,v4);

    IF p_date = mth_last_date then
       pymth_date = pymth_last_date;
    ELSE
      v1 = cast(p_date as varchar);
      v2 = substring(v1,1,4) - 1 ;
      v3 = substring(v1,5,4);
       pymth_date = concat( v2,v3 );
    END if;

*cast(sum(a.salesmonthly_ton) as abap.fltp(16,16) )


*--- Current Year sale - As on Date
  if p_typ_sale = 'CY' THEN
  cy_sale =      select a.mandt , substring(a.prodh,1,6) as prod_h, b.matnr,b.vbeln,b.vkbur,c.kunrg,
                 0.00 as  curry_mth_sale,
                    CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                    when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                    when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                    CASE WHEN C.vbtyp <> 'N' and C.vbtyp <> 'O' and C.vbtyp <> 'S' THEN
                        cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even)  as DEC (18,3) )
                       WHEN C.vbtyp = 'N'THEN
                          cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even) * - 1  as DEC (18,3) )
                        WHEN C.vbtyp = 'O' AND C.fkart = 'ZRTD' THEN
                          cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even) * - 1 as DEC (18,3) )
                        WHEN  C.vbtyp = 'S'  AND C.fkart = 'S2' AND C.fktyp = 'L' THEN
                         cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even)  as DEC (18,3) )
                       END
                     end as curry_sale ,
                     0.00 as  prey_mth_sale,
                     0.00 as prey_sale
                    from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                    inner join vbrk as c on b.vbeln = c.vbeln
                    left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                    marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                    left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and
                    marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                    where  a.stufe = '7'  and a.mandt = session_context( 'CLIENT' )
                    and c.vbtyp <> 'P' and ( c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO'  ) and c.vkorg in ( 1000 , 1001)
                    and C.fkdat between cy_first_date and p_date and  c.vtweg <> '15'
                     and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where  vkorg in ( 1000 , 1001)
                     and (  fkart = 'ZGST' or fkart = 'YSTO' ) and  fkdat between cy_first_date and p_date  )   )
*                    group by a.mandt, substring(a.prodh,1,6) ,b.matnr,C.vbtyp, b.vbeln,b.vkbur, C.fkart,C.fktyp, marm_from.umren, marm_to.umren
                    order by vbeln;

 else

 IF  p_typ_sale = 'PY' THEN

*--- Previous year sale - As on previous year date
 py_sale   =  SELECT a.mandt , substring(a.prodh,1,6) as prod_h, b.matnr,b.vbeln,b.vkbur,c.kunrg,
                    0.00 as  curry_mth_sale,
                    0.00 as curry_sale ,
                    0.00 as  prey_mth_sale,
                   CASE when marm_to.umren   = 0 or marm_to.umren   is null then 0.000
                   when marm_from.umren = 0 or marm_from.umren is NULL then 0.000
                   when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                   CASE WHEN C.vbtyp <> 'N' and C.vbtyp <> 'O' and C.vbtyp <> 'S' THEN
                       cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even)  as DEC (18,3) )
                      WHEN C.vbtyp = 'N'THEN
                       cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even) * - 1 as DEC (18,3) )
                       WHEN C.vbtyp = 'O' AND C.fkart = 'ZRTD' THEN
                        cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even) * - 1  as DEC (18,3) )
                       WHEN  c.vbtyp = 'S'  AND C.fkart = 'S2' AND C.fktyp = 'L' THEN
                       cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even)  as DEC (18,3) )
                     END
                   end as  prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on b.vbeln = c.vbeln
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' ) and
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                   where  a.stufe = '7'  and a.mandt = session_context( 'CLIENT' )
                   and c.vbtyp <> 'P' and (  c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO'  )
                   and c.vkorg in ( 1000 , 1001) and c.fkdat between py_first_date and pymth_date and c.vtweg <> '15'
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
                    and ( fkart = 'ZGST' or fkart = 'YSTO' )  and  fkdat between py_first_date and pymth_date   )   )
*                   group by a.mandt, substring(a.prodh,1,6) ,b.matnr,b.vbeln,b.vkbur,C.vbtyp,C.fkart ,C.fktyp,  marm_from.umren, marm_to.umren
                   ORDER BY vbeln;

   ELSE

* *-- Sale in  Current Year Month and Previous Year Same Month
 mth_tot_sale   =  SELECT a.mandt , substring(a.prodh,1,6) as prod_h, b.matnr ,b.vbeln,b.vkbur, c.kunrg,
                   CASE when ( marm_to.umren   = 0 or marm_to.umren   is null or marm_from.umren = 0 or marm_from.umren is NULL ) then 0.000
                       when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                        case when c.fkdat BETWEEN mth_first_date and p_date AND  ( c.vbtyp <> 'N' and  c.vbtyp <> 'O' and  c.vbtyp <> 'S' ) THEN
                         cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even)  as DEC (18,3) )
                         when c.fkdat BETWEEN mth_first_date and p_date and ( c.vbtyp = 'N' or  c.vbtyp = 'O' or c.vbtyp = 'S')   THEN
                            CASE WHEN  c.vbtyp = 'N' THEN
                             cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even) * - 1  as DEC (18,3) )
                            WHEN c.vbtyp = 'O' AND  C.fkart = 'ZRTD'THEN
                              cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even) * - 1  as DEC (18,3) )
                            when c.vbtyp = 'S' AND c.fkart = 'S2' AND C.fktyp = 'L' THEN
                              cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even)   as DEC (18,3) )
                            END
                        END
                     end as curry_mth_sale,
                     0.00 as curry_sale ,
                     CASE when ( marm_to.umren   = 0 or marm_to.umren   is null or marm_from.umren = 0 or marm_from.umren is NULL ) then 0.000
                       when marm_to.umren is NOT NULL and marm_from.umren is NOT NULL then
                       case when c.fkdat BETWEEN pymth_first_date and pymth_date AND  ( c.vbtyp <> 'N' and  c.vbtyp <> 'O'  and c.vbtyp <> 'S' ) THEN
                                cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even)  as DEC (18,3) )
                           when c.fkdat BETWEEN pymth_first_date and pymth_date AND  ( c.vbtyp = 'N' or  c.vbtyp = 'O'  or c.vbtyp = 'S' ) THEN
                             case WHEN  c.vbtyp = 'N' THEN
                                      cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even) * - 1 as DEC (18,3) )
                             WHEN c.vbtyp = 'O' AND C.fkart = 'ZRTD'THEN
                                      cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even) * - 1  as DEC (18,3) )
                            when c.vbtyp = 'S' AND  c.fkart = 'S2' AND C.fktyp = 'L' THEN
                              cast(round ( (b.fkimg * ( ( marm_from.umrez / marm_from.umren )  / ( marm_to.umrez / marm_to.umren) ) ) , 3, round_half_even)  as DEC (18,3) )
                            END
                          END
                       END as prey_mth_sale,
                   0.00 as  prey_sale
                   from t179 as a inner join vbrp as b ON a.mandt = b.mandt and a.prodh = b.prodh
                   inner join vbrk as c on b.vbeln = c.vbeln
                   left outer join marm as marm_from on marm_from.mandt = session_context( 'CLIENT' ) and
                   marm_from.matnr = b.matnr and marm_from.meinh = b.vrkme
                   left outer join marm as marm_to   on marm_to.mandt   = session_context( 'CLIENT' )  and
                   marm_to.matnr   = marm_from.matnr and   marm_to.meinh   = 'MT'
                   where  a.stufe = '7'  and a.mandt = session_context( 'CLIENT' )
                   and c.vbtyp <> 'P' AND ( c.fkart <> 'ZCEX' AND  c.fkart <> 'ZGST' and C.fkart <> 'YSTO') and c.vkorg in ( 1000 , 1001)
                   and (  C.fkdat between mth_first_date and p_date or C.fkdat BETWEEN py_first_date and pymth_date) and c.vtweg <> '15'
                   and c.vbeln not in ( select vbeln from vbrk where sfakn in ( select vbeln from vbrk where vkorg in ( 1000 , 1001)
                   and (fkart = 'ZGST' or fkart = 'YSTO' ) and ( fkdat between mth_first_date and p_date or C.fkdat BETWEEN py_first_date and pymth_date) ) )
*                   group by a.mandt, substring(a.prodh,1,6),b.matnr,b.vrkme,c.vbtyp,b.vbeln,b.vkbur,c.fkart,C.fktyp,marm_from.umren, marm_to.umren, c.fkdat
                   ORDER BY vbeln;

     END if;
   end if;


  total_sale =    select a.mandt , a.prod_h, a.matnr, a.vbeln , a.vkbur, a.kunrg , a.curry_mth_sale, a.curry_sale , a.prey_mth_sale, a.prey_sale from :cy_sale as a
                   union ALL
                  select b.mandt , b.prod_h, b.matnr , b.vbeln,b.vkbur,  b.kunrg , b.curry_mth_sale, b.curry_sale , b.prey_mth_sale, b.prey_sale from :py_sale as b
                   union ALL
                  select c.mandt , c.prod_h, c.matnr , c.vbeln, c.vkbur,  c.kunrg,  c.curry_mth_sale, c.curry_sale , c.prey_mth_sale, c.prey_sale from :mth_tot_sale as c;


 return select mandt , prod_h, matnr, vbeln, vkbur, kunrg , curry_mth_sale, curry_sale , prey_mth_sale, prey_sale from :total_sale;


  ENDMETHOD.
ENDCLASS.
